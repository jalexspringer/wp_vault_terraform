<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-03-11 Mon 13:36 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flux7 WP/Vault Presentation</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Alex Springer" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Flux7 WP/Vault Presentation</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org10a28c2">1. Introduction</a>
<ul>
<li><a href="#org4931147">1.1. Why use Vault?</a></li>
<li><a href="#org1671792">1.2. WP Deployment</a></li>
</ul>
</li>
<li><a href="#org0741d83">2. Config</a>
<ul>
<li><a href="#org897cdcd">2.1. Development Machine Setup</a>
<ul>
<li><a href="#orgd4ba76f">2.1.1. Tools</a></li>
</ul>
</li>
<li><a href="#org5a87fee">2.2. AWS Setup</a>
<ul>
<li><a href="#orgdecd9c0">2.2.1. Configure Route53</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org66ee702">3. Terraforming</a>
<ul>
<li><a href="#org536c7c2">3.1. Region and profile setup</a></li>
<li><a href="#org9d71b0e">3.2. Initialize Terraform</a></li>
<li><a href="#orga8fcb8f">3.3. IAM Access Roles (s3)</a></li>
<li><a href="#org4b58f01">3.4. Create the VPC</a>
<ul>
<li><a href="#org1a2787e">3.4.1. VPC Setup</a></li>
<li><a href="#org01518ee">3.4.2. Internet Gateway</a></li>
<li><a href="#org4dfb0df">3.4.3. Route Tables</a></li>
<li><a href="#org12d73db">3.4.4. Subnets</a></li>
<li><a href="#orgbd81372">3.4.5. Subnet Groups</a></li>
</ul>
</li>
<li><a href="#orgcc65e70">3.5. Security Groups</a>
<ul>
<li><a href="#org368ac6e">3.5.1. ELB</a></li>
<li><a href="#org1447ef8">3.5.2. Dev Instance</a></li>
<li><a href="#org82c8e19">3.5.3. Private Instances (Auto-scaling Group)</a></li>
<li><a href="#orge2f05f1">3.5.4. Database</a></li>
</ul>
</li>
<li><a href="#orge97da8d">3.6. S3 Bucket and VPC Endpoint</a>
<ul>
<li><a href="#orgca991bf">3.6.1. VPC Endpoint</a></li>
<li><a href="#org0609c18">3.6.2. S3 Bucket</a></li>
</ul>
</li>
<li><a href="#orgdf9a1e4">3.7. RDS</a></li>
<li><a href="#org2cf6deb">3.8. ELB</a></li>
<li><a href="#org0c5144e">3.9. Creating the Dev Instance</a></li>
<li><a href="#orgde711f2">3.10. Golden AMI</a></li>
<li><a href="#orgf6ac4b2">3.11. Auto-scaling Group and Launch Configuration</a></li>
<li><a href="#org82b8509">3.12. Route 53 Records</a></li>
</ul>
</li>
<li><a href="#orgfc3b5dd">4. Ansible</a>
<ul>
<li><a href="#org71a51a0">4.1. Install Wordpress</a></li>
<li><a href="#org01c8ccf">4.2. S3 Update</a></li>
</ul>
</li>
<li><a href="#orgd0f2937">5. Time to Apply!</a>
<ul>
<li><a href="#orgd3891c6">5.1. Next Steps</a></li>
</ul>
</li>
<li><a href="#org3fbcfa0">6. Adding the Vault</a>
<ul>
<li><a href="#orga1ea9a7">6.1. Deploy Vault in the VPC</a></li>
<li><a href="#org9231829">6.2. Security in depth with terraform and vault</a>
<ul>
<li><a href="#org2600225">6.2.1. basic principles for securing terraform state</a></li>
<li><a href="#org3344685">6.2.2. secrets generation and management in terraform</a></li>
<li><a href="#org51048b3">6.2.3. showcasae dynamic secrets engine with vault</a></li>
<li><a href="#orge4019b2">6.2.4. example terraform/vault integrations</a></li>
</ul>
</li>
<li><a href="#orgbd3bd9b">6.3. Using dynamic secrets to generate access credentials for secure terraform use</a></li>
<li><a href="#org195d1ee">6.4. Generating random DB credentials and storing them in vault</a></li>
</ul>
</li>
<li><a href="#org34ae8d4">7. TODOS <code>[0/2]</code></a>
<ul>
<li><a href="#orgeca326a">7.1. <span class="todo TODO">TODO</span> Add a bastion host to get into production via SSH</a></li>
<li><a href="#org6776e5b">7.2. <span class="todo TODO">TODO</span> Secure key access to dev host with Vault</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org10a28c2" class="outline-2">
<h2 id="org10a28c2"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
Walking through creating a highly available Wordpress blog using AWS and
Terraform. We'll then ensure high security by leveraging the power of Hashicorp
Vault to centralize control and auditing of secrets and access rights.
</p>
</div>

<div id="outline-container-org4931147" class="outline-3">
<h3 id="org4931147"><span class="section-number-3">1.1</span> Why use Vault?</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li>Dynamic generation of AWS access credentials based on IAM policies defined and
maintained via Terraform (Ifrastructure as Code practices)</li>
<li>Smaller attack surface - all secret are managed and distributed as needed with
a defined TTL to the various components of the application</li>
<li>Microservices friendly 'break glass' policies - respond to security breaches
in a targeted fashion that locks down only the affected parts of the system,
leading to higher durability and shorter recovery time</li>
<li>Full audit trail of all access and secret usage combined with easy to define
TTL to ensure correct access for all users</li>
<li>Simple encryption API for sensitive user/customer data</li>
</ul>
</div>
</div>

<div id="outline-container-org1671792" class="outline-3">
<h3 id="org1671792"><span class="section-number-3">1.2</span> WP Deployment</h3>
<div class="outline-text-3" id="text-1-2">
<p>
<a href="plan.png">Architecture Diagram</a>
</p>
</div>
</div>
</div>

<div id="outline-container-org0741d83" class="outline-2">
<h2 id="org0741d83"><span class="section-number-2">2</span> Config</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org897cdcd" class="outline-3">
<h3 id="org897cdcd"><span class="section-number-3">2.1</span> Development Machine Setup</h3>
<div class="outline-text-3" id="text-2-1">
</div>
<div id="outline-container-orgd4ba76f" class="outline-4">
<h4 id="orgd4ba76f"><span class="section-number-4">2.1.1</span> Tools</h4>
<div class="outline-text-4" id="text-2-1-1">
<ul class="org-ul">
<li>Python 3.7.2</li>
<li>Terraform v0.11.11</li>
<li>ansible 2.7.7</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org5a87fee" class="outline-3">
<h3 id="org5a87fee"><span class="section-number-3">2.2</span> AWS Setup</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>New User: cloudbase</li>
</ul>
<div class="org-src-container">
<pre class="src src-bash">aws configure --profile cb
</pre>
</div>
</div>

<div id="outline-container-orgdecd9c0" class="outline-4">
<h4 id="orgdecd9c0"><span class="section-number-4">2.2.1</span> Configure Route53</h4>
<div class="outline-text-4" id="text-2-2-1">
<p>
atcloudbase.net
</p>
<ul class="org-ul">
<li><p>
Get Route53 re-usable delegation set
</p>
<div class="org-src-container">
<pre class="src src-bash">aws route53 create-reusable-delegation-set --caller-reference <span style="color: #6c71c4; font-weight: bold;">1224</span> --profile cb
</pre>
</div></li>

<li>Update nameservers for atcloudbase.net</li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-org66ee702" class="outline-2">
<h2 id="org66ee702"><span class="section-number-2">3</span> Terraforming</h2>
<div class="outline-text-2" id="text-3">
<p>
Keeping secrets from git
</p>
<div class="org-src-container">
<pre class="src src-bash">**/.terraform/*
*.tfstate
*.tfstate.*
*.tfvars
.terraform
*.plan
credentials.csv
</pre>
</div>
</div>

<div id="outline-container-org536c7c2" class="outline-3">
<h3 id="org536c7c2"><span class="section-number-3">3.1</span> Region and profile setup</h3>
<div class="outline-text-3" id="text-3-1">
<div class="org-src-container">
<pre class="src src-bash">aws_profile = <span style="color: #2aa198;">"cb"</span>
aws_region  = <span style="color: #2aa198;">"us-east-1"</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash">provider <span style="color: #2aa198;">"aws"</span> <span style="color: #268bd2;">{</span>
  region  = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.aws_region}</span><span style="color: #2aa198;">"</span>
  profile = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.aws_profile}</span><span style="color: #2aa198;">"</span>
<span style="color: #268bd2;">}</span>

</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash">variable <span style="color: #2aa198;">"aws_region"</span>  <span style="color: #268bd2;">{}</span>
variable <span style="color: #2aa198;">"aws_profile"</span> <span style="color: #268bd2;">{}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org9d71b0e" class="outline-3">
<h3 id="org9d71b0e"><span class="section-number-3">3.2</span> Initialize Terraform</h3>
<div class="outline-text-3" id="text-3-2">
<div class="org-src-container">
<pre class="src src-bash">terraform init
</pre>
</div>
</div>
</div>
<div id="outline-container-orga8fcb8f" class="outline-3">
<h3 id="orga8fcb8f"><span class="section-number-3">3.3</span> IAM Access Roles (s3)</h3>
<div class="outline-text-3" id="text-3-3">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #96A7A9; font-style: italic;">#</span><span style="color: #96A7A9; font-style: italic;">----- IAM -----</span>

<span style="color: #96A7A9; font-style: italic;">#</span><span style="color: #96A7A9; font-style: italic;">S3_access</span>
resource <span style="color: #2aa198;">"aws_iam_instance_profile"</span> <span style="color: #2aa198;">"s3_access_profile"</span> <span style="color: #268bd2;">{</span>
  name = <span style="color: #2aa198;">"s3_access"</span>
  role = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_iam_role.s3_access_role.name}</span><span style="color: #2aa198;">"</span>
<span style="color: #268bd2;">}</span>

resource <span style="color: #2aa198;">"aws_iam_role_policy"</span> <span style="color: #2aa198;">"s3_access_policy"</span> <span style="color: #268bd2;">{</span>
  name = <span style="color: #2aa198;">"s3_access_policy"</span>
  role = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_iam_role.s3_access_role.id}</span><span style="color: #2aa198;">"</span>

  policy = &lt;&lt;EOF
<span style="color: #2aa198;">{</span>
<span style="color: #2aa198;">  "Version": "2012-10-17",</span>
<span style="color: #2aa198;">  "Statement": [</span>
<span style="color: #2aa198;">    {</span>
<span style="color: #2aa198;">      "Effect": "Allow",</span>
<span style="color: #2aa198;">      "Action": "s3:*",</span>
<span style="color: #2aa198;">      "Resource": "*"</span>
<span style="color: #2aa198;">      }</span>
<span style="color: #2aa198;">    ]</span>
<span style="color: #2aa198;">  }</span>
<span style="color: #2aa198;">EOF</span>
<span style="color: #268bd2;">}</span>


resource <span style="color: #2aa198;">"aws_iam_role"</span> <span style="color: #2aa198;">"s3_access_role"</span> <span style="color: #268bd2;">{</span>
  name = <span style="color: #2aa198;">"s3_access_role"</span>

  assume_role_policy = &lt;&lt;EOF
<span style="color: #2aa198;">{</span>
<span style="color: #2aa198;">  "Version": "2012-10-17",</span>
<span style="color: #2aa198;">  "Statement": [</span>
<span style="color: #2aa198;">      {</span>
<span style="color: #2aa198;">        "Action": "sts:AssumeRole",</span>
<span style="color: #2aa198;">        "Principal": {</span>
<span style="color: #2aa198;">          "Service": "ec2.amazonaws.com"</span>
<span style="color: #2aa198;">          },</span>
<span style="color: #2aa198;">        "Effect": "Allow",</span>
<span style="color: #2aa198;">        "Sid": ""</span>
<span style="color: #2aa198;">      }</span>
<span style="color: #2aa198;">    ]</span>
<span style="color: #2aa198;">  }</span>
<span style="color: #2aa198;">EOF</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4b58f01" class="outline-3">
<h3 id="org4b58f01"><span class="section-number-3">3.4</span> Create the VPC</h3>
<div class="outline-text-3" id="text-3-4">
</div>
<div id="outline-container-org1a2787e" class="outline-4">
<h4 id="org1a2787e"><span class="section-number-4">3.4.1</span> VPC Setup</h4>
<div class="outline-text-4" id="text-3-4-1">
<p>
Define the VPC resource, references CIDR block variable
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #96A7A9; font-style: italic;">#</span><span style="color: #96A7A9; font-style: italic;">----- VPC ------</span>

resource <span style="color: #2aa198;">"aws_vpc"</span> <span style="color: #2aa198;">"wp_vpc"</span> <span style="color: #268bd2;">{</span>
  cidr_block           = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.vpc_cidr}</span><span style="color: #2aa198;">"</span>
  enable_dns_hostnames = true
  enable_dns_support   = true

  tags <span style="color: #d33682;">{</span>
    Name = <span style="color: #2aa198;">"wp_vpc"</span>
  <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>

<p>
Define the CIDR block variable in terraform.tfvars and variables.tf
</p>
<div class="org-src-container">
<pre class="src src-bash">vpc_cidr = <span style="color: #2aa198;">"10.0.0.0/16"</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-bash">variable <span style="color: #2aa198;">"vpc_cidr"</span> <span style="color: #268bd2;">{}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org01518ee" class="outline-4">
<h4 id="org01518ee"><span class="section-number-4">3.4.2</span> Internet Gateway</h4>
<div class="outline-text-4" id="text-3-4-2">
<div class="org-src-container">
<pre class="src src-bash">
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">Internet Gateway</span>
resource <span style="color: #2aa198;">"aws_internet_gateway"</span> <span style="color: #2aa198;">"wp_internet_gateway"</span> <span style="color: #268bd2;">{</span>
  vpc_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_vpc.wp_vpc.id}</span><span style="color: #2aa198;">"</span>

  tags <span style="color: #d33682;">{</span>
    Name = <span style="color: #2aa198;">"wp_igw"</span>
  <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

</pre>
</div>
</div>
</div>

<div id="outline-container-org4dfb0df" class="outline-4">
<h4 id="org4dfb0df"><span class="section-number-4">3.4.3</span> Route Tables</h4>
<div class="outline-text-4" id="text-3-4-3">
<div class="org-src-container">
<pre class="src src-bash">
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">Route Tables</span>
resource <span style="color: #2aa198;">"aws_route_table"</span> <span style="color: #2aa198;">"wp_public_rt"</span> <span style="color: #268bd2;">{</span>
  vpc_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_vpc.wp_vpc.id}</span><span style="color: #2aa198;">"</span>

  route <span style="color: #d33682;">{</span>
    cidr_block = <span style="color: #2aa198;">"0.0.0.0/0"</span>
    gateway_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_internet_gateway.wp_internet_gateway.id}</span><span style="color: #2aa198;">"</span>
  <span style="color: #d33682;">}</span>

  tags <span style="color: #d33682;">{</span>
    Name = <span style="color: #2aa198;">"wp_public"</span>
  <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

resource <span style="color: #2aa198;">"aws_default_route_table"</span> <span style="color: #2aa198;">"wp_private_rt"</span> <span style="color: #268bd2;">{</span>
  default_route_table_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_vpc.wp_vpc.default_route_table_id}</span><span style="color: #2aa198;">"</span>

  tags <span style="color: #d33682;">{</span>
    Name = <span style="color: #2aa198;">"wp_private"</span>
  <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org12d73db" class="outline-4">
<h4 id="org12d73db"><span class="section-number-4">3.4.4</span> Subnets</h4>
<div class="outline-text-4" id="text-3-4-4">
<p>
Gather the availability zone information and create cidr blocks array
</p>
<div class="org-src-container">
<pre class="src src-bash">cidrs = <span style="color: #268bd2;">{</span>
  public1  = <span style="color: #2aa198;">"10.0.1.0/24"</span>
  public2  = <span style="color: #2aa198;">"10.0.2.0/24"</span>
  private1 = <span style="color: #2aa198;">"10.0.3.0/24"</span>
  private2 = <span style="color: #2aa198;">"10.0.4.0/24"</span>
  rds1     = <span style="color: #2aa198;">"10.0.5.0/24"</span>
  rds2     = <span style="color: #2aa198;">"10.0.6.0/24"</span>
  rds3     = <span style="color: #2aa198;">"10.0.7.0/24"</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash">data <span style="color: #2aa198;">"aws_availability_zones"</span> <span style="color: #2aa198;">"available"</span> <span style="color: #268bd2;">{}</span>
variable <span style="color: #2aa198;">"cidrs"</span> <span style="color: #268bd2;">{</span>
  <span style="color: #d33682; font-style: italic;">type</span> = <span style="color: #2aa198;">"map"</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">Subnets</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">Public subnets</span>
resource <span style="color: #2aa198;">"aws_subnet"</span> <span style="color: #2aa198;">"wp_public1_subnet"</span> <span style="color: #268bd2;">{</span>
  vpc_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_vpc.wp_vpc.id}</span><span style="color: #2aa198;">"</span>
  cidr_block = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.cidrs["</span><span style="color: #268bd2;">public1</span><span style="color: #268bd2;">"]}</span><span style="color: #2aa198;">"</span>
  map_public_ip_on_launch = true
  availability_zone = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{data.aws_availability_zones.available.names[0]}</span><span style="color: #2aa198;">"</span>

  tags <span style="color: #d33682;">{</span>
    Name = <span style="color: #2aa198;">"wp_public1"</span>
  <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

resource <span style="color: #2aa198;">"aws_subnet"</span> <span style="color: #2aa198;">"wp_public2_subnet"</span> <span style="color: #268bd2;">{</span>
  vpc_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_vpc.wp_vpc.id}</span><span style="color: #2aa198;">"</span>
  cidr_block = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.cidrs["</span><span style="color: #268bd2;">public2</span><span style="color: #268bd2;">"]}</span><span style="color: #2aa198;">"</span>
  map_public_ip_on_launch = true
  availability_zone = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{data.aws_availability_zones.available.names[1]}</span><span style="color: #2aa198;">"</span>

  tags <span style="color: #d33682;">{</span>
    Name = <span style="color: #2aa198;">"wp_public2"</span>
  <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">Private Subnets</span>
resource <span style="color: #2aa198;">"aws_subnet"</span> <span style="color: #2aa198;">"wp_private1_subnet"</span> <span style="color: #268bd2;">{</span>
  vpc_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_vpc.wp_vpc.id}</span><span style="color: #2aa198;">"</span>
  cidr_block = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.cidrs["</span><span style="color: #268bd2;">private1</span><span style="color: #268bd2;">"]}</span><span style="color: #2aa198;">"</span>
  map_public_ip_on_launch = false
  availability_zone = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{data.aws_availability_zones.available.names[0]}</span><span style="color: #2aa198;">"</span>

  tags <span style="color: #d33682;">{</span>
    Name = <span style="color: #2aa198;">"wp_private1"</span>
  <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

resource <span style="color: #2aa198;">"aws_subnet"</span> <span style="color: #2aa198;">"wp_private2_subnet"</span> <span style="color: #268bd2;">{</span>
  vpc_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_vpc.wp_vpc.id}</span><span style="color: #2aa198;">"</span>
  cidr_block = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.cidrs["</span><span style="color: #268bd2;">private2</span><span style="color: #268bd2;">"]}</span><span style="color: #2aa198;">"</span>
  map_public_ip_on_launch = false
  availability_zone = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{data.aws_availability_zones.available.names[1]}</span><span style="color: #2aa198;">"</span>

  tags <span style="color: #d33682;">{</span>
    Name = <span style="color: #2aa198;">"wp_private2"</span>
  <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">RDS Subnets</span>
resource <span style="color: #2aa198;">"aws_subnet"</span> <span style="color: #2aa198;">"wp_rds1_subnet"</span> <span style="color: #268bd2;">{</span>
  vpc_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_vpc.wp_vpc.id}</span><span style="color: #2aa198;">"</span>
  cidr_block = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.cidrs["</span><span style="color: #268bd2;">rds1</span><span style="color: #268bd2;">"]}</span><span style="color: #2aa198;">"</span>
  map_public_ip_on_launch = false
  availability_zone = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{data.aws_availability_zones.available.names[0]}</span><span style="color: #2aa198;">"</span>

  tags <span style="color: #d33682;">{</span>
    Name = <span style="color: #2aa198;">"wp_rds1"</span>
  <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

resource <span style="color: #2aa198;">"aws_subnet"</span> <span style="color: #2aa198;">"wp_rds2_subnet"</span> <span style="color: #268bd2;">{</span>
  vpc_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_vpc.wp_vpc.id}</span><span style="color: #2aa198;">"</span>
  cidr_block = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.cidrs["</span><span style="color: #268bd2;">rds2</span><span style="color: #268bd2;">"]}</span><span style="color: #2aa198;">"</span>
  map_public_ip_on_launch = false
  availability_zone = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{data.aws_availability_zones.available.names[1]}</span><span style="color: #2aa198;">"</span>

  tags <span style="color: #d33682;">{</span>
    Name = <span style="color: #2aa198;">"wp_rds2"</span>
  <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

resource <span style="color: #2aa198;">"aws_subnet"</span> <span style="color: #2aa198;">"wp_rds3_subnet"</span> <span style="color: #268bd2;">{</span>
  vpc_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_vpc.wp_vpc.id}</span><span style="color: #2aa198;">"</span>
  cidr_block = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.cidrs["</span><span style="color: #268bd2;">rds3</span><span style="color: #268bd2;">"]}</span><span style="color: #2aa198;">"</span>
  map_public_ip_on_launch = false
  availability_zone = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{data.aws_availability_zones.available.names[2]}</span><span style="color: #2aa198;">"</span>

  tags <span style="color: #d33682;">{</span>
    Name = <span style="color: #2aa198;">"wp_rds3"</span>
  <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-orgbd81372" class="outline-4">
<h4 id="orgbd81372"><span class="section-number-4">3.4.5</span> Subnet Groups</h4>
<div class="outline-text-4" id="text-3-4-5">
<p>
RDS Groups
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">RDS Subnet Group</span>

resource <span style="color: #2aa198;">"aws_db_subnet_group"</span> <span style="color: #2aa198;">"wp_rds_subnetgroup"</span> <span style="color: #268bd2;">{</span>
  name = <span style="color: #2aa198;">"wp_rds_subnetgroup"</span>

  subnet_ids = <span style="color: #d33682;">[</span>
    <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_subnet.wp_rds1_subnet.id}</span><span style="color: #2aa198;">"</span>,
    <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_subnet.wp_rds2_subnet.id}</span><span style="color: #2aa198;">"</span>,
    <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_subnet.wp_rds3_subnet.id}</span><span style="color: #2aa198;">"</span>
  <span style="color: #d33682;">]</span>

  tags <span style="color: #d33682;">{</span>
    Name = <span style="color: #2aa198;">"wp_rds_sng"</span>
  <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>


<p>
Public Subnet Associations
</p>
<div class="org-src-container">
<pre class="src src-bash">
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">Public Subnet Associations</span>

resource <span style="color: #2aa198;">"aws_route_table_association"</span> <span style="color: #2aa198;">"wp_public_assoc1"</span> <span style="color: #268bd2;">{</span>
  subnet_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_subnet.wp_public1_subnet.id}</span><span style="color: #2aa198;">"</span>
  route_table_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_route_table.wp_public_rt.id}</span><span style="color: #2aa198;">"</span>
<span style="color: #268bd2;">}</span>

resource <span style="color: #2aa198;">"aws_route_table_association"</span> <span style="color: #2aa198;">"wp_public_assoc2"</span> <span style="color: #268bd2;">{</span>
  subnet_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_subnet.wp_public2_subnet.id}</span><span style="color: #2aa198;">"</span>
  route_table_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_route_table.wp_public_rt.id}</span><span style="color: #2aa198;">"</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>

<p>
Clean up - terraform the terraforming
</p>
<div class="org-src-container">
<pre class="src src-bash">terraform fmt
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgcc65e70" class="outline-3">
<h3 id="orgcc65e70"><span class="section-number-3">3.5</span> Security Groups</h3>
<div class="outline-text-3" id="text-3-5">
</div>

<div id="outline-container-org368ac6e" class="outline-4">
<h4 id="org368ac6e"><span class="section-number-4">3.5.1</span> ELB</h4>
<div class="outline-text-4" id="text-3-5-1">
<p>
Port 80 open
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #96A7A9; font-style: italic;">#</span><span style="color: #96A7A9; font-style: italic;">----- Security Groups -----</span>

<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">Public Sec Group</span>
resource <span style="color: #2aa198;">"aws_security_group"</span> <span style="color: #2aa198;">"wp_public_sg"</span> <span style="color: #268bd2;">{</span>
  name = <span style="color: #2aa198;">"wp_public_sg"</span>
  description = <span style="color: #2aa198;">"ELB public access"</span>
  vpc_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_vpc.wp_vpc.id}</span><span style="color: #2aa198;">"</span>

  <span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">HTTP</span>
  ingress <span style="color: #d33682;">{</span>
    from_port = <span style="color: #6c71c4; font-weight: bold;">80</span>
    to_port = <span style="color: #6c71c4; font-weight: bold;">80</span>
    protocol = <span style="color: #2aa198;">"tcp"</span>
    cidr_blocks = <span style="color: #859900;">[</span><span style="color: #2aa198;">"0.0.0.0/0"</span><span style="color: #859900;">]</span>
  <span style="color: #d33682;">}</span>

  egress <span style="color: #d33682;">{</span>
    from_port = <span style="color: #6c71c4; font-weight: bold;">0</span>
    to_port = <span style="color: #6c71c4; font-weight: bold;">0</span>
    protocol = <span style="color: #2aa198;">"-1"</span>
    cidr_blocks = <span style="color: #859900;">[</span><span style="color: #2aa198;">"0.0.0.0/0"</span><span style="color: #859900;">]</span>
  <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1447ef8" class="outline-4">
<h4 id="org1447ef8"><span class="section-number-4">3.5.2</span> Dev Instance</h4>
<div class="outline-text-4" id="text-3-5-2">
<p>
HTTP, SSH access from local IP
</p>

<div class="org-src-container">
<pre class="src src-bash">localip = <span style="color: #2aa198;">"0.0.0.0/0"</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash">variable <span style="color: #2aa198;">"localip"</span> <span style="color: #268bd2;">{}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash">
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">Dev access from local IP</span>

resource <span style="color: #2aa198;">"aws_security_group"</span> <span style="color: #2aa198;">"wp_dev_sg"</span> <span style="color: #268bd2;">{</span>
  name = <span style="color: #2aa198;">"wp_dev_sg"</span>
  description = <span style="color: #2aa198;">"Used for access to the dev instance"</span>
  vpc_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_vpc.wp_vpc.id}</span><span style="color: #2aa198;">"</span>

  <span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">SSH Rules</span>

  ingress <span style="color: #d33682;">{</span>
    from_port = <span style="color: #6c71c4; font-weight: bold;">22</span>
    to_port = <span style="color: #6c71c4; font-weight: bold;">22</span>
    protocol = <span style="color: #2aa198;">"tcp"</span>
    cidr_blocks = <span style="color: #859900;">[</span><span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.localip}</span><span style="color: #2aa198;">"</span><span style="color: #859900;">]</span>
  <span style="color: #d33682;">}</span>

  <span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">HTTP</span>

  ingress <span style="color: #d33682;">{</span>
    from_port = <span style="color: #6c71c4; font-weight: bold;">80</span>
    to_port = <span style="color: #6c71c4; font-weight: bold;">80</span>
    protocol = <span style="color: #2aa198;">"tcp"</span>
    cidr_blocks = <span style="color: #859900;">[</span><span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.localip}</span><span style="color: #2aa198;">"</span><span style="color: #859900;">]</span>
  <span style="color: #d33682;">}</span>

  egress <span style="color: #d33682;">{</span>
  from_port = <span style="color: #6c71c4; font-weight: bold;">0</span>
  to_port = <span style="color: #6c71c4; font-weight: bold;">0</span>
  protocol = <span style="color: #2aa198;">"-1"</span>
  cidr_blocks = <span style="color: #859900;">[</span><span style="color: #2aa198;">"0.0.0.0/0"</span><span style="color: #859900;">]</span>
  <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

</pre>
</div>
</div>
</div>

<div id="outline-container-org82c8e19" class="outline-4">
<h4 id="org82c8e19"><span class="section-number-4">3.5.3</span> Private Instances (Auto-scaling Group)</h4>
<div class="outline-text-4" id="text-3-5-3">
<p>
Access only within VPC
</p>
<div class="org-src-container">
<pre class="src src-bash">
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">Access to entire VPC CIDR</span>

resource <span style="color: #2aa198;">"aws_security_group"</span> <span style="color: #2aa198;">"wp_private_sg"</span> <span style="color: #268bd2;">{</span>
  name = <span style="color: #2aa198;">"wp_private_sg"</span>
  description = <span style="color: #2aa198;">"Private network access to from VPC"</span>
  vpc_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_vpc.wp_vpc.id}</span><span style="color: #2aa198;">"</span>

  ingress <span style="color: #d33682;">{</span>
    from_port = <span style="color: #6c71c4; font-weight: bold;">0</span>
    to_port = <span style="color: #6c71c4; font-weight: bold;">0</span>
    protocol = <span style="color: #2aa198;">"-1"</span>
    cidr_blocks = <span style="color: #859900;">[</span><span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.vpc_cidr}</span><span style="color: #2aa198;">"</span><span style="color: #859900;">]</span>
  <span style="color: #d33682;">}</span>

  egress <span style="color: #d33682;">{</span>
    from_port = <span style="color: #6c71c4; font-weight: bold;">0</span>
    to_port = <span style="color: #6c71c4; font-weight: bold;">0</span>
    protocol = <span style="color: #2aa198;">"-1"</span>
    cidr_blocks = <span style="color: #859900;">[</span><span style="color: #2aa198;">"0.0.0.0/0"</span><span style="color: #859900;">]</span>
  <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge2f05f1" class="outline-4">
<h4 id="orge2f05f1"><span class="section-number-4">3.5.4</span> Database</h4>
<div class="outline-text-4" id="text-3-5-4">
<p>
Only VPC, port 3306 (MYSQL)
</p>
<div class="org-src-container">
<pre class="src src-bash">
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">RDS Security Group</span>

resource <span style="color: #2aa198;">"aws_security_group"</span> <span style="color: #2aa198;">"wp_rds_sg"</span> <span style="color: #268bd2;">{</span>
  name = <span style="color: #2aa198;">"wp_rds_sg"</span>
  description = <span style="color: #2aa198;">"Restricted access for RDS instances"</span>
  vpc_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_vpc.wp_vpc.id}</span><span style="color: #2aa198;">"</span>

  ingress <span style="color: #d33682;">{</span>
    to_port = <span style="color: #6c71c4; font-weight: bold;">3306</span>
    from_port = <span style="color: #6c71c4; font-weight: bold;">3306</span>
    protocol = <span style="color: #2aa198;">"tcp"</span>

    security_groups = <span style="color: #859900;">[</span><span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_security_group.wp_dev_sg.id}</span><span style="color: #2aa198;">"</span>,
      <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_security_group.wp_public_sg.id}</span><span style="color: #2aa198;">"</span>,
      <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_security_group.wp_private_sg.id}</span><span style="color: #2aa198;">"</span>
    <span style="color: #859900;">]</span>
  <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orge97da8d" class="outline-3">
<h3 id="orge97da8d"><span class="section-number-3">3.6</span> S3 Bucket and VPC Endpoint</h3>
<div class="outline-text-3" id="text-3-6">
</div>
<div id="outline-container-orgca991bf" class="outline-4">
<h4 id="orgca991bf"><span class="section-number-4">3.6.1</span> VPC Endpoint</h4>
<div class="outline-text-4" id="text-3-6-1">
<div class="org-src-container">
<pre class="src src-bash">
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">----- S3 VPC Endpoint -----</span>

resource <span style="color: #2aa198;">"aws_vpc_endpoint"</span> <span style="color: #2aa198;">"wp_private-s3_endpoint"</span> <span style="color: #268bd2;">{</span>
  service_name = <span style="color: #2aa198;">"com.amazonaws.</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.aws_region}</span><span style="color: #2aa198;">.s3"</span>
  vpc_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_vpc.wp_vpc.id}</span><span style="color: #2aa198;">"</span>

  route_table_ids = <span style="color: #d33682;">[</span><span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_vpc.wp_vpc.main_route_table_id}</span><span style="color: #2aa198;">"</span>,
                     <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_route_table.wp_public_rt.id}</span><span style="color: #2aa198;">"</span>
                    <span style="color: #d33682;">]</span>
  policy = &lt;&lt;POLICY
<span style="color: #2aa198;">{</span>
<span style="color: #2aa198;">    "Statement": [</span>
<span style="color: #2aa198;">      {</span>
<span style="color: #2aa198;">        "Action": "*",</span>
<span style="color: #2aa198;">        "Effect": "Allow",</span>
<span style="color: #2aa198;">        "Resource": "*",</span>
<span style="color: #2aa198;">        "Principal": "*"</span>
<span style="color: #2aa198;">      }</span>
<span style="color: #2aa198;">    ]</span>
<span style="color: #2aa198;">}</span>
<span style="color: #2aa198;">POLICY</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org0609c18" class="outline-4">
<h4 id="org0609c18"><span class="section-number-4">3.6.2</span> S3 Bucket</h4>
<div class="outline-text-4" id="text-3-6-2">
<div class="org-src-container">
<pre class="src src-bash">variable <span style="color: #2aa198;">"domain_name"</span> <span style="color: #268bd2;">{}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash">domain_name = <span style="color: #2aa198;">"atcloudbase"</span>
</pre>
</div>

<p>
Getting a random bucket name
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #96A7A9; font-style: italic;">#</span><span style="color: #96A7A9; font-style: italic;">----- S3 Code Bucket -----</span>

resource <span style="color: #2aa198;">"random_id"</span> <span style="color: #2aa198;">"wp_code_bucket"</span> <span style="color: #268bd2;">{</span>
  byte_length = <span style="color: #6c71c4; font-weight: bold;">2</span>
<span style="color: #268bd2;">}</span>

resource <span style="color: #2aa198;">"aws_s3_bucket"</span> <span style="color: #2aa198;">"code"</span> <span style="color: #268bd2;">{</span>
  bucket = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.domain_name}</span><span style="color: #2aa198;">-</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{random_id.wp_code_bucket.dec}</span><span style="color: #2aa198;">"</span>
  acl = <span style="color: #2aa198;">"private"</span>
  force_destroy = true

  tags <span style="color: #d33682;">{</span>
    Name = <span style="color: #2aa198;">"code bucket"</span>
  <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>

<p>
NOTE: Must re-run terraform init to initialize the 'random' plugin
</p>
</div>
</div>
</div>

<div id="outline-container-orgdf9a1e4" class="outline-3">
<h3 id="orgdf9a1e4"><span class="section-number-3">3.7</span> RDS</h3>
<div class="outline-text-3" id="text-3-7">
<p>
Before there was Vault and secure creds creation&#x2026;
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #96A7A9; font-style: italic;">#</span><span style="color: #96A7A9; font-style: italic;">----- RDS ------</span>

resource <span style="color: #2aa198;">"aws_db_instance"</span> <span style="color: #2aa198;">"wp_db"</span> <span style="color: #268bd2;">{</span>
  allocated_storage = <span style="color: #6c71c4; font-weight: bold;">10</span>
  engine = <span style="color: #2aa198;">"mysql"</span>
  engine_version = <span style="color: #2aa198;">"5.7"</span>
  instance_class = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.db_instance_class}</span><span style="color: #2aa198;">"</span>
  name = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.dbname}</span><span style="color: #2aa198;">"</span>
  username = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.dbuser}</span><span style="color: #2aa198;">"</span>
  password = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.dbpass}</span><span style="color: #2aa198;">"</span>
  db_subnet_group_name = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_db_subnet_group.wp_rds_subnetgroup.name}</span><span style="color: #2aa198;">"</span>
  vpc_security_group_ids = <span style="color: #d33682;">[</span><span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_security_group.wp_rds_sg.id}</span><span style="color: #2aa198;">"</span><span style="color: #d33682;">]</span>
  skip_final_snapshot = true
<span style="color: #268bd2;">}</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-bash">variable <span style="color: #2aa198;">"db_instance_class"</span> <span style="color: #268bd2;">{}</span>
variable <span style="color: #2aa198;">"dbname"</span> <span style="color: #268bd2;">{}</span>
variable <span style="color: #2aa198;">"dbuser"</span> <span style="color: #268bd2;">{}</span>
variable <span style="color: #2aa198;">"dbpass"</span> <span style="color: #268bd2;">{}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash">db_instance_class = <span style="color: #2aa198;">"db.t2.micro"</span>
dbname = <span style="color: #2aa198;">"cbdb"</span>
dbuser = <span style="color: #2aa198;">"cloudbase"</span>
dbpass = <span style="color: #2aa198;">"cbdbpassing"</span>
</pre>
</div>

<p>
NOTE: Plain text pass used here for example purposes. See below for
implementation of Vault to create dynamic credentials.
</p>
</div>
</div>

<div id="outline-container-org2cf6deb" class="outline-3">
<h3 id="org2cf6deb"><span class="section-number-3">3.8</span> ELB</h3>
<div class="outline-text-3" id="text-3-8">
<p>
TODO :: Update to Application Load Balancer
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #96A7A9; font-style: italic;">#</span><span style="color: #96A7A9; font-style: italic;">----- ELB -----</span>

resource <span style="color: #2aa198;">"aws_elb"</span> <span style="color: #2aa198;">"wp_elb"</span> <span style="color: #268bd2;">{</span>
  name = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.domain_name}</span><span style="color: #2aa198;">-elb"</span>

  subnets = <span style="color: #d33682;">[</span><span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_subnet.wp_public1_subnet.id}</span><span style="color: #2aa198;">"</span>,
            <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_subnet.wp_public2_subnet.id}</span><span style="color: #2aa198;">"</span><span style="color: #d33682;">]</span>

  security_groups = <span style="color: #d33682;">[</span><span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_security_group.wp_public_sg.id}</span><span style="color: #2aa198;">"</span><span style="color: #d33682;">]</span>

  listener <span style="color: #d33682;">{</span>
    instance_port = <span style="color: #6c71c4; font-weight: bold;">80</span>
    instance_protocol = <span style="color: #2aa198;">"http"</span>
    lb_port = <span style="color: #6c71c4; font-weight: bold;">80</span>
    lb_protocol = <span style="color: #2aa198;">"http"</span>
  <span style="color: #d33682;">}</span>

  health_check <span style="color: #d33682;">{</span>
    healthy_threshold = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.elb_healthy_threshold}</span><span style="color: #2aa198;">"</span>
    unhealthy_threshold = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.elb_unhealthy_threshold}</span><span style="color: #2aa198;">"</span>
    timeout = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.elb_timeout}</span><span style="color: #2aa198;">"</span>
    target = <span style="color: #2aa198;">"TCP:80"</span>
    interval = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.elb_interval}</span><span style="color: #2aa198;">"</span>
  <span style="color: #d33682;">}</span>

  cross_zone_load_balancing = true
  idle_timeout = <span style="color: #6c71c4; font-weight: bold;">400</span>
  connection_draining = true
  connection_draining_timeout = <span style="color: #6c71c4; font-weight: bold;">400</span>

  tags <span style="color: #d33682;">{</span>
    Name = <span style="color: #2aa198;">"wp_</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.domain_name}</span><span style="color: #2aa198;">-elb"</span>
  <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash">variable <span style="color: #2aa198;">"elb_healthy_threshold"</span> <span style="color: #268bd2;">{}</span>
variable <span style="color: #2aa198;">"elb_unhealthy_threshold"</span> <span style="color: #268bd2;">{}</span>
variable <span style="color: #2aa198;">"elb_timeout"</span> <span style="color: #268bd2;">{}</span>
variable <span style="color: #2aa198;">"elb_interval"</span> <span style="color: #268bd2;">{}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash">elb_healthy_threshold = <span style="color: #2aa198;">"2"</span>
elb_unhealthy_threshold = <span style="color: #2aa198;">"2"</span>
elb_timeout = <span style="color: #2aa198;">"3"</span>
elb_interval = <span style="color: #2aa198;">"30"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org0c5144e" class="outline-3">
<h3 id="org0c5144e"><span class="section-number-3">3.9</span> Creating the Dev Instance</h3>
<div class="outline-text-3" id="text-3-9">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #96A7A9; font-style: italic;">#</span><span style="color: #96A7A9; font-style: italic;">----- Dev -----</span>

<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">Key Pair</span>

resource <span style="color: #2aa198;">"aws_key_pair"</span> <span style="color: #2aa198;">"wp_auth"</span> <span style="color: #268bd2;">{</span>
  key_name = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.key_name}</span><span style="color: #2aa198;">"</span>
  public_key = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{file(var.public_key_path)}</span><span style="color: #2aa198;">"</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">Dev Server</span>

resource <span style="color: #2aa198;">"aws_instance"</span> <span style="color: #2aa198;">"wp_dev"</span> <span style="color: #268bd2;">{</span>
  instance_type = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.dev_instance_type}</span><span style="color: #2aa198;">"</span>
  ami = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.dev_ami}</span><span style="color: #2aa198;">"</span>

  tags <span style="color: #d33682;">{</span>
    Name = <span style="color: #2aa198;">"wp_dev"</span>
  <span style="color: #d33682;">}</span>

  key_name = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_key_pair.wp_auth.id}</span><span style="color: #2aa198;">"</span>
  vpc_security_group_ids = <span style="color: #d33682;">[</span><span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_security_group.wp_dev_sg.id}</span><span style="color: #2aa198;">"</span><span style="color: #d33682;">]</span>
  iam_instance_profile = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_iam_instance_profile.s3_access_profile.id}</span><span style="color: #2aa198;">"</span>
  subnet_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_subnet.wp_public1_subnet.id}</span><span style="color: #2aa198;">"</span>

  <span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">user_data = "${data.template_file.user_data.rendered}"</span>
  provisioner <span style="color: #2aa198;">"local-exec"</span> <span style="color: #d33682;">{</span>
    <span style="color: #d33682; font-style: italic;">command</span> = &lt;&lt;EOD
<span style="color: #2aa198; font-style: italic;">cat</span><span style="color: #2aa198;"> &lt;&lt;EOF &gt; aws_hosts</span>
<span style="color: #2aa198;">[dev]</span>
<span style="color: #2aa198;">${aws_instance.wp_dev.public_ip}</span>
<span style="color: #2aa198;">[dev:vars]</span>
<span style="color: #2aa198;">s3code=${aws_s3_bucket.code.bucket}</span>
<span style="color: #2aa198;">domain=${var.domain_name}</span>
<span style="color: #2aa198;">EOF</span>
<span style="color: #2aa198;">EOD</span>
  <span style="color: #d33682;">}</span>
    provisioner <span style="color: #2aa198;">"local-exec"</span> <span style="color: #d33682;">{</span>
        <span style="color: #d33682; font-style: italic;">command</span> = <span style="color: #2aa198;">"aws ec2 wait instance-status-ok --instance-ids </span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_instance.wp_dev.id}</span><span style="color: #2aa198;"> --profile </span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.aws_profile}</span><span style="color: #2aa198;"> &amp;&amp; ansible-playbook -i aws_hosts --extra-vars 'dbname=</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.dbname}</span><span style="color: #2aa198;"> dbuser=</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{random_string.username.result}</span><span style="color: #2aa198;"> dbpass=</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{random_string.password.result}</span><span style="color: #2aa198;"> dbaddr=db.</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.domain_name}</span><span style="color: #2aa198;">.net' wordpress.yml"</span>
   <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash">variable <span style="color: #2aa198;">"dev_instance_type"</span> <span style="color: #268bd2;">{}</span>
variable <span style="color: #2aa198;">"dev_ami"</span> <span style="color: #268bd2;">{}</span>
variable <span style="color: #2aa198;">"public_key_path"</span> <span style="color: #268bd2;">{}</span>
variable <span style="color: #2aa198;">"key_name"</span> <span style="color: #268bd2;">{}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash">dev_instance_type = <span style="color: #2aa198;">"t2.micro"</span>
dev_ami = <span style="color: #2aa198;">"ami-b73b63a0"</span>
public_key_path = <span style="color: #2aa198;">"/home/alexs/.ssh/cloudbase.pub"</span>
key_name = <span style="color: #2aa198;">"cloudbase"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgde711f2" class="outline-3">
<h3 id="orgde711f2"><span class="section-number-3">3.10</span> Golden AMI</h3>
<div class="outline-text-3" id="text-3-10">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #96A7A9; font-style: italic;">#</span><span style="color: #96A7A9; font-style: italic;">----- Golden AMI ------</span>

<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">random AMI ID</span>

resource <span style="color: #2aa198;">"random_id"</span> <span style="color: #2aa198;">"golden_ami"</span> <span style="color: #268bd2;">{</span>
  byte_length = <span style="color: #6c71c4; font-weight: bold;">3</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">AMI</span>

resource <span style="color: #2aa198;">"aws_ami_from_instance"</span> <span style="color: #2aa198;">"wp_golden"</span> <span style="color: #268bd2;">{</span>
  name = <span style="color: #2aa198;">"wp_ami-</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{random_id.golden_ami.b64}</span><span style="color: #2aa198;">"</span>
  source_instance_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_instance.wp_dev.id}</span><span style="color: #2aa198;">"</span>

  provisioner <span style="color: #2aa198;">"local-exec"</span> <span style="color: #d33682;">{</span>
    <span style="color: #d33682; font-style: italic;">command</span> = &lt;&lt;EOT
<span style="color: #2aa198; font-style: italic;">cat</span><span style="color: #2aa198;"> &lt;&lt;EOF &gt; userdata</span>
<span style="color: #2aa198;">#!/bin/bash</span>
<span style="color: #2aa198;">/usr/bin/aws s3 sync s3://${aws_s3_bucket.code.bucket} /var/www/html/</span>
<span style="color: #2aa198;">/bin/touch /var/spool/cron/root</span>
<span style="color: #2aa198; font-style: italic;">sudo</span><span style="color: #2aa198;"> /bin/echo '*/5 * * * * aws s3 sync s3://${aws_s3_bucket.code.bucket} /var/www/html' &gt;&gt; /var/spool/cron/root</span>
<span style="color: #2aa198;">EOF</span>
<span style="color: #2aa198;">EOT</span>
  <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf6ac4b2" class="outline-3">
<h3 id="orgf6ac4b2"><span class="section-number-3">3.11</span> Auto-scaling Group and Launch Configuration</h3>
<div class="outline-text-3" id="text-3-11">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #96A7A9; font-style: italic;">#</span><span style="color: #96A7A9; font-style: italic;">----- Launch Config -----</span>

resource <span style="color: #2aa198;">"aws_launch_configuration"</span> <span style="color: #2aa198;">"wp_lc"</span> <span style="color: #268bd2;">{</span>
  name_prefix = <span style="color: #2aa198;">"wp_lc-"</span>
  image_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_ami_from_instance.wp_golden.id}</span><span style="color: #2aa198;">"</span>
  instance_type = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.lc_instance_type}</span><span style="color: #2aa198;">"</span>
  security_groups = <span style="color: #d33682;">[</span><span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_security_group.wp_private_sg.id}</span><span style="color: #2aa198;">"</span><span style="color: #d33682;">]</span>
  iam_instance_profile = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_iam_instance_profile.s3_access_profile.id}</span><span style="color: #2aa198;">"</span>
  key_name = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_key_pair.wp_auth.id}</span><span style="color: #2aa198;">"</span>
  user_data = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{file("</span><span style="color: #268bd2;">userdata</span><span style="color: #268bd2;">")}</span><span style="color: #2aa198;">"</span>

  lifecycle <span style="color: #d33682;">{</span>
    create_before_destroy = true
  <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">#</span><span style="color: #96A7A9; font-style: italic;">----- ASG -----</span>

resource <span style="color: #2aa198;">"aws_autoscaling_group"</span> <span style="color: #2aa198;">"wp_asg"</span> <span style="color: #268bd2;">{</span>
  name = <span style="color: #2aa198;">"asg-</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_launch_configuration.wp_lc.id}</span><span style="color: #2aa198;">"</span>
  max_size = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.asg_max}</span><span style="color: #2aa198;">"</span>
  min_size = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.asg_min}</span><span style="color: #2aa198;">"</span>
  health_check_grace_period = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.asg_grace}</span><span style="color: #2aa198;">"</span>
  health_check_type = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.asg_hct}</span><span style="color: #2aa198;">"</span>
  desired_capacity = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.asg_cap}</span><span style="color: #2aa198;">"</span>
  force_delete = true
  load_balancers = <span style="color: #d33682;">[</span><span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_elb.wp_elb.id}</span><span style="color: #2aa198;">"</span><span style="color: #d33682;">]</span>

  vpc_zone_identifier = <span style="color: #d33682;">[</span><span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_subnet.wp_private1_subnet.id}</span><span style="color: #2aa198;">"</span>,
                         <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_subnet.wp_private2_subnet.id}</span><span style="color: #2aa198;">"</span>
                        <span style="color: #d33682;">]</span>
  launch_configuration = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_launch_configuration.wp_lc.name}</span><span style="color: #2aa198;">"</span>

  tag <span style="color: #d33682;">{</span>
    key = <span style="color: #2aa198;">"Name"</span>
    value = <span style="color: #2aa198;">"wp_asg-instance"</span>
    propagate_at_launch = true
  <span style="color: #d33682;">}</span>

  lifecycle <span style="color: #d33682;">{</span>
    create_before_destroy = true
  <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash">variable <span style="color: #2aa198;">"lc_instance_type"</span> <span style="color: #268bd2;">{}</span>
variable <span style="color: #2aa198;">"asg_max"</span> <span style="color: #268bd2;">{}</span>
variable <span style="color: #2aa198;">"asg_min"</span> <span style="color: #268bd2;">{}</span>
variable <span style="color: #2aa198;">"asg_grace"</span> <span style="color: #268bd2;">{}</span>
variable <span style="color: #2aa198;">"asg_hct"</span> <span style="color: #268bd2;">{}</span>
variable <span style="color: #2aa198;">"asg_cap"</span> <span style="color: #268bd2;">{}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash">lc_instance_type = <span style="color: #2aa198;">"t2.micro"</span>
asg_max = <span style="color: #2aa198;">"2"</span>
asg_min = <span style="color: #2aa198;">"1"</span>
asg_grace = <span style="color: #2aa198;">"300"</span>
asg_hct = <span style="color: #2aa198;">"EC2"</span>
asg_cap = <span style="color: #2aa198;">"2"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org82b8509" class="outline-3">
<h3 id="org82b8509"><span class="section-number-3">3.12</span> Route 53 Records</h3>
<div class="outline-text-3" id="text-3-12">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #96A7A9; font-style: italic;">#</span><span style="color: #96A7A9; font-style: italic;">----- Route 53 -----</span>

<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">Primary Zone</span>

resource <span style="color: #2aa198;">"aws_route53_zone"</span> <span style="color: #2aa198;">"primary"</span> <span style="color: #268bd2;">{</span>
  name = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.domain_name}</span><span style="color: #2aa198;">.net"</span>
  delegation_set_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.delegation_set}</span><span style="color: #2aa198;">"</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">WWW Record</span>

resource <span style="color: #2aa198;">"aws_route53_record"</span> <span style="color: #2aa198;">"www"</span> <span style="color: #268bd2;">{</span>
  zone_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_route53_zone.primary.zone_id}</span><span style="color: #2aa198;">"</span>
  name = <span style="color: #2aa198;">"www.</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.domain_name}</span><span style="color: #2aa198;">.net"</span>
  <span style="color: #d33682; font-style: italic;">type</span> = <span style="color: #2aa198;">"A"</span>

  <span style="color: #d33682; font-style: italic;">alias</span> <span style="color: #d33682;">{</span>
    name = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_elb.wp_elb.dns_name}</span><span style="color: #2aa198;">"</span>
    zone_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_elb.wp_elb.zone_id}</span><span style="color: #2aa198;">"</span>
    evaluate_target_health = false
  <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">Dev Record</span>

resource <span style="color: #2aa198;">"aws_route53_record"</span> <span style="color: #2aa198;">"dev"</span> <span style="color: #268bd2;">{</span>
  zone_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_route53_zone.primary.zone_id}</span><span style="color: #2aa198;">"</span>
  name = <span style="color: #2aa198;">"dev.</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.domain_name}</span><span style="color: #2aa198;">.net"</span>
  <span style="color: #d33682; font-style: italic;">type</span> = <span style="color: #2aa198;">"A"</span>
  ttl = <span style="color: #2aa198;">"300"</span>
  records = <span style="color: #d33682;">[</span><span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_instance.wp_dev.public_ip}</span><span style="color: #2aa198;">"</span><span style="color: #d33682;">]</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">Private Zone</span>

resource <span style="color: #2aa198;">"aws_route53_zone"</span> <span style="color: #2aa198;">"secondary"</span> <span style="color: #268bd2;">{</span>
  name = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.domain_name}</span><span style="color: #2aa198;">.net"</span>
  vpc <span style="color: #d33682;">{</span>
    vpc_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_vpc.wp_vpc.id}</span><span style="color: #2aa198;">"</span>
  <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">DB Record</span>

resource <span style="color: #2aa198;">"aws_route53_record"</span> <span style="color: #2aa198;">"db"</span> <span style="color: #268bd2;">{</span>
  zone_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_route53_zone.secondary.zone_id}</span><span style="color: #2aa198;">"</span>
  name = <span style="color: #2aa198;">"db.</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.domain_name}</span><span style="color: #2aa198;">.net"</span>
  <span style="color: #d33682; font-style: italic;">type</span> = <span style="color: #2aa198;">"CNAME"</span>
  ttl = <span style="color: #2aa198;">"300"</span>
  records = <span style="color: #d33682;">[</span><span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_db_instance.wp_db.address}</span><span style="color: #2aa198;">"</span><span style="color: #d33682;">]</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash">variable <span style="color: #2aa198;">"delegation_set"</span> <span style="color: #268bd2;">{}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash">delegation_set = <span style="color: #2aa198;">"N2WOUDW0QCOUSM"</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgfc3b5dd" class="outline-2">
<h2 id="orgfc3b5dd"><span class="section-number-2">4</span> Ansible</h2>
<div class="outline-text-2" id="text-4">
<p>
Using the right tool for the job - Terraform is great for infrastructure
management, while Ansible handles configuration of instances.
</p>

<p>
Config Note: host<sub>key</sub><sub>checking</sub> = false in /etc/ansible/ansible.cfg
</p>
</div>

<div id="outline-container-org71a51a0" class="outline-3">
<h3 id="org71a51a0"><span class="section-number-3">4.1</span> Install Wordpress</h3>
<div class="outline-text-3" id="text-4-1">
<div class="org-src-container">
<pre class="src src-bash">---
- hosts: dev
  become: yes
  remote_user: ec2-user
  tasks:
    - name: Install Apache
      yum: <span style="color: #268bd2;">name</span>=<span style="color: #268bd2;">{</span><span style="color: #d33682;">{</span> item <span style="color: #d33682;">}</span><span style="color: #268bd2;">}</span> <span style="color: #268bd2;">state</span>=present
      with_items:
      - httpd
      - php
      - php-mysql
    - name: Make Dir Tree Readable
      file:
        path: /var/www/html
        mode: <span style="color: #268bd2;">u</span>=rwX,<span style="color: #268bd2;">g</span>=rX,<span style="color: #268bd2;">o</span>=rX
        recurse: yes
        owner: apache
        group: apache
    - name: Download Wordpress
      get_url: <span style="color: #268bd2;">url</span>=http://wordpress.org/wordpress-latest.tar.gz <span style="color: #268bd2;">dest</span>=/var/www/html/wordpress.tar.gz <span style="color: #268bd2;">force</span>=yes
    - name: Extract Wordpress
      <span style="color: #d33682; font-style: italic;">command</span>: <span style="color: #2aa198;">"tar xzf /var/www/html/wordpress.tar.gz -C /var/www/html --strip-components 1"</span>
    - name: Copy wp-config-sample.php to wp-config.php
      <span style="color: #d33682; font-style: italic;">command</span>: <span style="color: #b58900; font-style: italic;">cp</span> <span style="color: #2aa198;">"/var/www/html/wp-config-sample.php"</span> <span style="color: #2aa198;">"/var/www/html/wp-config.php"</span>
    - name: Update database credentials<span style="color: #859900;"> in</span> the file
      replace:
        path: <span style="color: #2aa198;">"/var/www/html/wp-config.php"</span>
        regexp: <span style="color: #2aa198;">"password_here"</span>
        replace: <span style="color: #2aa198;">"{{ dbpass }}"</span>

    - name: Update database name<span style="color: #859900;"> in</span> the file
      replace:
        path: <span style="color: #2aa198;">"/var/www/html/wp-config.php"</span>
        regexp: <span style="color: #2aa198;">"database_name_here"</span>
        replace: <span style="color: #2aa198;">"{{ dbname }}"</span>

    - name: Update database user<span style="color: #859900;"> in</span> the file
      replace:
        path: <span style="color: #2aa198;">"/var/www/html/wp-config.php"</span>
        regexp: <span style="color: #2aa198;">"username_here"</span>
        replace: <span style="color: #2aa198;">"{{ dbuser }}"</span>

    - name: Update database address<span style="color: #859900;"> in</span> the file
      replace:
        path: <span style="color: #2aa198;">"/var/www/html/wp-config.php"</span>
        regexp: <span style="color: #2aa198;">"localhost"</span>
        replace: <span style="color: #2aa198;">"{{ dbaddr }}"</span>


    - name: Start and enable Apache
      service: <span style="color: #268bd2;">name</span>=httpd <span style="color: #268bd2;">state</span>=started <span style="color: #268bd2;">enabled</span>=yes
</pre>
</div>
</div>
</div>

<div id="outline-container-org01c8ccf" class="outline-3">
<h3 id="org01c8ccf"><span class="section-number-3">4.2</span> S3 Update</h3>
<div class="outline-text-3" id="text-4-2">
<div class="org-src-container">
<pre class="src src-bash">---
- hosts: dev
  become: yes
  remote_user: ec2-user
  tasks:
  - name: Update s3 code bucket
    <span style="color: #d33682; font-style: italic;">command</span>: aws s3 sync /var/www/html s3://<span style="color: #268bd2;">{</span><span style="color: #d33682;">{</span> s3code <span style="color: #d33682;">}</span><span style="color: #268bd2;">}</span>/ --delete
  - shell: <span style="color: #b58900; font-style: italic;">echo</span> <span style="color: #2aa198;">"define('WP_SITEURL','http://dev."</span><span style="color: #268bd2;">{</span><span style="color: #d33682;">{</span> domain <span style="color: #d33682;">}</span><span style="color: #268bd2;">}</span><span style="color: #2aa198;">".net');"</span> &gt;&gt; wp-config.php
    args:
      chdir: /var/www/html
  - shell: <span style="color: #b58900; font-style: italic;">echo</span> <span style="color: #2aa198;">"define('WP_HOME,'http://dev."</span><span style="color: #268bd2;">{</span><span style="color: #d33682;">{</span> domain <span style="color: #d33682;">}</span><span style="color: #268bd2;">}</span><span style="color: #2aa198;">".net');"</span> &gt;&gt; wp-config.php
    args:
      chdir: /var/www/html
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd0f2937" class="outline-2">
<h2 id="orgd0f2937"><span class="section-number-2">5</span> Time to Apply!</h2>
<div class="outline-text-2" id="text-5">
<div class="org-src-container">
<pre class="src src-bash">ssh-agent bash
ssh-add ~/.ssh/cloudbase
terraform plan --out terraform.plan
terraform
</pre>
</div>
</div>

<div id="outline-container-orgd3891c6" class="outline-3">
<h3 id="orgd3891c6"><span class="section-number-3">5.1</span> Next Steps</h3>
<div class="outline-text-3" id="text-5-1">
<ol class="org-ol">
<li>Visit dev.atcloudbase.net and perform WP initial setup and config</li>
<li>Change settings to visit www. instead of dev.</li>
<li>Run 'ansible-playbook -i aws<sub>hosts</sub> s3update.yml' (after all config changes on
dev)</li>
<li>Install an s3 fileshare plugin (change to cloudfront for future state)</li>
</ol>
</div>
</div>
</div>
<div id="outline-container-org3fbcfa0" class="outline-2">
<h2 id="org3fbcfa0"><span class="section-number-2">6</span> Adding the Vault</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-orga1ea9a7" class="outline-3">
<h3 id="orga1ea9a7"><span class="section-number-3">6.1</span> Deploy Vault in the VPC</h3>
<div class="outline-text-3" id="text-6-1">
<p>
Deploying vault in the same VPC as WP using existing private subnets.
</p>

<p>
Once complete this does require SSH in, vault operator init, unseal
</p>

<p>
Set local environment variable VAULT<sub>ADDR</sub> and VAULT<sub>SKIP</sub><sub>VERIFY</sub> (look into
getting around this for production deploys)
</p>

<p>
vault login with token to get it all together
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">:tangle variables.tf</span>
variable vc_ami_id <span style="color: #268bd2;">{}</span>
variable vault_cluster_name <span style="color: #268bd2;">{}</span>
variable consul_cluster_name <span style="color: #268bd2;">{}</span>
variable vault_cluster_size <span style="color: #268bd2;">{}</span>
variable consul_cluster_size <span style="color: #268bd2;">{}</span>
variable vault_instance_type <span style="color: #268bd2;">{}</span>
variable consul_instance_type <span style="color: #268bd2;">{}</span>
variable consul_cluster_tag_key <span style="color: #268bd2;">{}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #96A7A9; font-style: italic;">#  </span><span style="color: #96A7A9; font-style: italic;">:tangle terraform.tfvars</span>
vc_ami_id = <span style="color: #2aa198;">"ami-0d3b2cf862bc2d41b"</span>
vault_cluster_name = <span style="color: #2aa198;">"vault-s3"</span>
consul_cluster_name = <span style="color: #2aa198;">"consul-s3"</span>
vault_cluster_size = <span style="color: #2aa198;">"3"</span>
consul_cluster_size = <span style="color: #2aa198;">"3"</span>
vault_instance_type = <span style="color: #2aa198;">"t2.micro"</span>
consul_instance_type = <span style="color: #2aa198;">"t2.micro"</span>
consul_cluster_tag_key = <span style="color: #2aa198;">"consul-vault-s3-servers"</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">---------------------------------------------------------------------------------------------------------------------</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">DEPLOY THE VAULT SERVER CLUSTER</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">---------------------------------------------------------------------------------------------------------------------</span>

module <span style="color: #2aa198;">"vault_cluster"</span> <span style="color: #268bd2;">{</span>
  <span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">When using these modules in your own templates, you will need to use a Git URL with a ref attribute that pins you</span>
  <span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">to a specific version of the modules, such as the following example:</span>
  <span style="color: #d33682; font-style: italic;">source</span> = <span style="color: #2aa198;">"github.com/hashicorp/terraform-aws-vault//modules/vault-cluster?ref=v0.0.1"</span>
  cluster_name  = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.vault_cluster_name}</span><span style="color: #2aa198;">"</span>
  cluster_size  = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.vault_cluster_size}</span><span style="color: #2aa198;">"</span>
  instance_type = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.vault_instance_type}</span><span style="color: #2aa198;">"</span>

  ami_id    = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.vc_ami_id}</span><span style="color: #2aa198;">"</span>
  user_data = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{data.template_file.user_data_vault_cluster.rendered}</span><span style="color: #2aa198;">"</span>

  vpc_id     = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_vpc.wp_vpc.id}</span><span style="color: #2aa198;">"</span>
  subnet_ids = <span style="color: #d33682;">[</span><span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_subnet.wp_public1_subnet.id}</span><span style="color: #2aa198;">"</span>,
    <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_subnet.wp_public2_subnet.id}</span><span style="color: #2aa198;">"</span><span style="color: #d33682;">]</span>

  <span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">To </span><span style="color: #96A7A9; font-style: italic;">make</span><span style="color: #96A7A9; font-style: italic;"> testing easier, we allow requests from any IP address here but in a production deployment, we *strongly*</span>
  <span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">recommend you limit this to the IP address ranges of known, trusted servers inside your VPC.</span>

  allowed_ssh_cidr_blocks              = <span style="color: #d33682;">[</span><span style="color: #2aa198;">"0.0.0.0/0"</span><span style="color: #d33682;">]</span>
  allowed_inbound_cidr_blocks          = <span style="color: #d33682;">[</span><span style="color: #2aa198;">"0.0.0.0/0"</span><span style="color: #d33682;">]</span>
  allowed_inbound_security_group_ids   = <span style="color: #d33682;">[]</span>
  ssh_key_name                         = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.key_name}</span><span style="color: #2aa198;">"</span>
  s3_bucket_name = <span style="color: #2aa198;">"hello-big-time12335425432"</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">---------------------------------------------------------------------------------------------------------------------</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">ATTACH IAM POLICIES FOR CONSUL</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">To allow our Vault servers to automatically discover the Consul servers, we need to give them the IAM permissions from</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">the Consul AWS Module's consul-iam-policies module.</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">---------------------------------------------------------------------------------------------------------------------</span>

module <span style="color: #2aa198;">"consul_iam_policies_servers"</span> <span style="color: #268bd2;">{</span>
  <span style="color: #d33682; font-style: italic;">source</span> = <span style="color: #2aa198;">"github.com/hashicorp/terraform-aws-consul.git//modules/consul-iam-policies?ref=v0.4.0"</span>

  iam_role_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{module.vault_cluster.iam_role_id}</span><span style="color: #2aa198;">"</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">---------------------------------------------------------------------------------------------------------------------</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">THE USER DATA SCRIPT THAT WILL RUN ON EACH VAULT SERVER WHEN IT'S BOOTING</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">This script will configure and start Vault</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">---------------------------------------------------------------------------------------------------------------------</span>

data <span style="color: #2aa198;">"template_file"</span> <span style="color: #2aa198;">"user_data_vault_cluster"</span> <span style="color: #268bd2;">{</span>
  template = <span style="color: #2aa198;">"${file("</span>$<span style="color: #d33682;">{</span><span style="color: #268bd2;">path</span>.module<span style="color: #d33682;">}</span>/user-data-vault.sh<span style="color: #2aa198;">")}"</span>

  vars <span style="color: #d33682;">{</span>
    aws_region               = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.aws_region}</span><span style="color: #2aa198;">"</span>
    consul_cluster_tag_key   = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.consul_cluster_tag_key}</span><span style="color: #2aa198;">"</span>
    consul_cluster_tag_value = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.consul_cluster_name}</span><span style="color: #2aa198;">"</span>
  <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">---------------------------------------------------------------------------------------------------------------------</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">PERMIT CONSUL SPECIFIC TRAFFIC IN VAULT CLUSTER</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">To allow our Vault servers consul agents to communicate with other consul agents and participate in the LAN gossip,</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">we open up the consul specific protocols and ports for consul traffic</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">---------------------------------------------------------------------------------------------------------------------</span>

module <span style="color: #2aa198;">"security_group_rules"</span> <span style="color: #268bd2;">{</span>
  <span style="color: #d33682; font-style: italic;">source</span> = <span style="color: #2aa198;">"github.com/hashicorp/terraform-aws-consul.git//modules/consul-client-security-group-rules?ref=v0.4.0"</span>

  security_group_id = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{module.vault_cluster.security_group_id}</span><span style="color: #2aa198;">"</span>

  <span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">To </span><span style="color: #96A7A9; font-style: italic;">make</span><span style="color: #96A7A9; font-style: italic;"> testing easier, we allow requests from any IP address here but in a production deployment, we *strongly*</span>
  <span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">recommend you limit this to the IP address ranges of known, trusted servers inside your VPC.</span>

  allowed_inbound_cidr_blocks = <span style="color: #d33682;">[</span><span style="color: #2aa198;">"0.0.0.0/0"</span><span style="color: #d33682;">]</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">---------------------------------------------------------------------------------------------------------------------</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">DEPLOY THE CONSUL SERVER CLUSTER</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">---------------------------------------------------------------------------------------------------------------------</span>

module <span style="color: #2aa198;">"consul_cluster"</span> <span style="color: #268bd2;">{</span>
  <span style="color: #d33682; font-style: italic;">source</span> = <span style="color: #2aa198;">"github.com/hashicorp/terraform-aws-consul.git//modules/consul-cluster?ref=v0.4.0"</span>

  cluster_name  = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.consul_cluster_name}</span><span style="color: #2aa198;">"</span>
  cluster_size  = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.consul_cluster_size}</span><span style="color: #2aa198;">"</span>
  instance_type = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.consul_instance_type}</span><span style="color: #2aa198;">"</span>

  <span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">The EC2 Instances will use these tags to automatically discover each other and form a cluster</span>
  cluster_tag_key   = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.consul_cluster_tag_key}</span><span style="color: #2aa198;">"</span>
  cluster_tag_value = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.consul_cluster_name}</span><span style="color: #2aa198;">"</span>

  ami_id    = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.vc_ami_id}</span><span style="color: #2aa198;">"</span>
  user_data = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{data.template_file.user_data_consul.rendered}</span><span style="color: #2aa198;">"</span>

  vpc_id     = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_vpc.wp_vpc.id}</span><span style="color: #2aa198;">"</span>
  subnet_ids = <span style="color: #d33682;">[</span><span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_subnet.wp_public1_subnet.id}</span><span style="color: #2aa198;">"</span>,
    <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_subnet.wp_public2_subnet.id}</span><span style="color: #2aa198;">"</span><span style="color: #d33682;">]</span>

  <span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">To </span><span style="color: #96A7A9; font-style: italic;">make</span><span style="color: #96A7A9; font-style: italic;"> testing easier, we allow Consul and SSH requests from any IP address here but in a production</span>
  <span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">deployment, we strongly recommend you limit this to the IP address ranges of known, trusted servers inside your VPC.</span>

  allowed_ssh_cidr_blocks     = <span style="color: #d33682;">[</span><span style="color: #2aa198;">"0.0.0.0/0"</span><span style="color: #d33682;">]</span>
  allowed_inbound_cidr_blocks = <span style="color: #d33682;">[</span><span style="color: #2aa198;">"0.0.0.0/0"</span><span style="color: #d33682;">]</span>
  ssh_key_name                = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.key_name}</span><span style="color: #2aa198;">"</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">---------------------------------------------------------------------------------------------------------------------</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">THE USER DATA SCRIPT THAT WILL RUN ON EACH CONSUL SERVER WHEN IT'S BOOTING</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">This script will configure and start Consul</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">---------------------------------------------------------------------------------------------------------------------</span>

data <span style="color: #2aa198;">"template_file"</span> <span style="color: #2aa198;">"user_data_consul"</span> <span style="color: #268bd2;">{</span>
  template = <span style="color: #2aa198;">"${file("</span>$<span style="color: #d33682;">{</span><span style="color: #268bd2;">path</span>.module<span style="color: #d33682;">}</span>/user-data-consul.sh<span style="color: #2aa198;">")}"</span>

  vars <span style="color: #d33682;">{</span>
    consul_cluster_tag_key   = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.consul_cluster_tag_key}</span><span style="color: #2aa198;">"</span>
    consul_cluster_tag_value = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.consul_cluster_name}</span><span style="color: #2aa198;">"</span>
  <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #96A7A9; font-style: italic;">#</span><span style="color: #96A7A9; font-style: italic;">!/bin/</span><span style="color: #859900;">bash</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">This script is meant to be run in the User Data of each EC2 Instance while it's booting. The script uses the</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">run-consul script to configure and start Consul in client mode and then the run-vault script to configure and start</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">Vault in server mode. Note that this script assumes it's running in an AMI built from the Packer template in</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">examples/vault-consul-ami/vault-consul.json.</span>

<span style="color: #d33682; font-style: italic;">set</span> -e

<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">Send the log output from this script to user-data.log, syslog, and the console</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">From: https://alestic.com/2010/12/ec2-user-data-output/</span>
<span style="color: #859900;">exec</span> &gt; &gt;<span style="color: #268bd2;">(</span>tee /var/log/user-data.log|logger -t user-data -s <span style="color: #6c71c4; font-weight: bold;">2</span>&gt;/dev/console<span style="color: #268bd2;">)</span> <span style="color: #6c71c4; font-weight: bold;">2</span>&gt;&amp;<span style="color: #6c71c4; font-weight: bold;">1</span>

<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">The Packer template puts the TLS certs in these file paths</span>
<span style="color: #d33682; font-style: italic;">readonly</span> <span style="color: #268bd2;">VAULT_TLS_CERT_FILE</span>=<span style="color: #2aa198;">"/opt/vault/tls/vault.crt.pem"</span>
<span style="color: #d33682; font-style: italic;">readonly</span> <span style="color: #268bd2;">VAULT_TLS_KEY_FILE</span>=<span style="color: #2aa198;">"/opt/vault/tls/vault.key.pem"</span>

<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">The variables below are filled in via Terraform interpolation</span>
/opt/consul/bin/run-consul --client --cluster-tag-key <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{consul_cluster_tag_key}</span><span style="color: #2aa198;">"</span> --cluster-tag-value <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{consul_cluster_tag_value}</span><span style="color: #2aa198;">"</span>
/opt/vault/bin/run-vault --tls-cert-file <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">VAULT_TLS_CERT_FILE</span><span style="color: #2aa198;">"</span>  --tls-key-file <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">VAULT_TLS_KEY_FILE</span><span style="color: #2aa198;">"</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #96A7A9; font-style: italic;">#</span><span style="color: #96A7A9; font-style: italic;">!/bin/</span><span style="color: #859900;">bash</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">This script is meant to be run in the User Data of each EC2 Instance while it's booting. The script uses the</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">run-consul script to configure and start Consul in server mode. Note that this script assumes it's running in an AMI</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">built from the Packer template in examples/vault-consul-ami/vault-consul.json.</span>

<span style="color: #d33682; font-style: italic;">set</span> -e

<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">Send the log output from this script to user-data.log, syslog, and the console</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">From: https://alestic.com/2010/12/ec2-user-data-output/</span>
<span style="color: #859900;">exec</span> &gt; &gt;<span style="color: #268bd2;">(</span>tee /var/log/user-data.log|logger -t user-data -s <span style="color: #6c71c4; font-weight: bold;">2</span>&gt;/dev/console<span style="color: #268bd2;">)</span> <span style="color: #6c71c4; font-weight: bold;">2</span>&gt;&amp;<span style="color: #6c71c4; font-weight: bold;">1</span>

<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">These variables are passed in via Terraform template interpolation</span>
/opt/consul/bin/run-consul --server --cluster-tag-key <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{consul_cluster_tag_key}</span><span style="color: #2aa198;">"</span> --cluster-tag-value <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{consul_cluster_tag_value}</span><span style="color: #2aa198;">"</span>
</pre>
</div>
</div>
</div>



<div id="outline-container-org9231829" class="outline-3">
<h3 id="org9231829"><span class="section-number-3">6.2</span> <a href="https://www.youtube.com/watch?time_continue=1&amp;v=W30HKivEFWg">Security in depth with terraform and vault</a></h3>
<div class="outline-text-3" id="text-6-2">
</div>
<div id="outline-container-org2600225" class="outline-4">
<h4 id="org2600225"><span class="section-number-4">6.2.1</span> basic principles for securing terraform state</h4>
<div class="outline-text-4" id="text-6-2-1">
<p>
terraform state can contain sensitive data in the first place
protect state files as secrets
</p>

<p>
use an encrypted backend (encrypted s3)
</p>
</div>
</div>

<div id="outline-container-org3344685" class="outline-4">
<h4 id="org3344685"><span class="section-number-4">6.2.2</span> secrets generation and management in terraform</h4>
<div class="outline-text-4" id="text-6-2-2">
<p>
terraform can generate random username/passwords
use resource "random<sub>string</sub>", assign and use as username/pass
upload and store these credentials in vault
resource "vault<sub>dynamic</sub><sub>secret</sub>" "credentials"
</p>
</div>
</div>
<div id="outline-container-org51048b3" class="outline-4">
<h4 id="org51048b3"><span class="section-number-4">6.2.3</span> showcasae dynamic secrets engine with vault</h4>
<div class="outline-text-4" id="text-6-2-3">
<p>
better option! dynamic secrets backend
ex. create mysql users, use the hvac python library in application code to
securly interact with the database from the application
</p>
</div>
</div>

<div id="outline-container-orge4019b2" class="outline-4">
<h4 id="orge4019b2"><span class="section-number-4">6.2.4</span> example terraform/vault integrations</h4>
</div>
</div>
<div id="outline-container-orgbd3bd9b" class="outline-3">
<h3 id="orgbd3bd9b"><span class="section-number-3">6.3</span> Using dynamic secrets to generate access credentials for secure terraform use</h3>
<div class="outline-text-3" id="text-6-3">
<p>
Admin setup of backend role
</p>
<div class="org-src-container">
<pre class="src src-bash">resource <span style="color: #2aa198;">"vault_aws_secret_backend"</span> <span style="color: #2aa198;">"aws"</span> <span style="color: #268bd2;">{</span>
  region = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.aws_region}</span><span style="color: #2aa198;">"</span>
  default_lease_ttl_seconds = <span style="color: #2aa198;">"120"</span>
  max_lease_ttl_seconds     = <span style="color: #2aa198;">"240"</span>
<span style="color: #268bd2;">}</span>
resource <span style="color: #2aa198;">"vault_aws_secret_backend_role"</span> <span style="color: #2aa198;">"ec2-admin"</span> <span style="color: #268bd2;">{</span>
  backend = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{vault_aws_secret_backend.aws.path}</span><span style="color: #2aa198;">"</span>
  name    = <span style="color: #2aa198;">"ec2-admin-role"</span>
policy = &lt;&lt;EOF
<span style="color: #2aa198;">{</span>
<span style="color: #2aa198;">  "Version": "2012-10-17",</span>
<span style="color: #2aa198;">  "Statement": [</span>
<span style="color: #2aa198;">    {</span>
<span style="color: #2aa198;">      "Effect": "Allow",</span>
<span style="color: #2aa198;">      "Action": [</span>
<span style="color: #2aa198;">        "iam:*", "ec2:*"</span>
<span style="color: #2aa198;">      ],</span>
<span style="color: #2aa198;">      "Resource": "*"</span>
<span style="color: #2aa198;">    }</span>
<span style="color: #2aa198;">  ]</span>
<span style="color: #2aa198;">}</span>
<span style="color: #2aa198;">EOF</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash">data <span style="color: #2aa198;">"vault_aws_access_credentials"</span> <span style="color: #2aa198;">"creds"</span> <span style="color: #268bd2;">{</span>
  backend = <span style="color: #2aa198;">"aws"</span>
  role    = <span style="color: #2aa198;">"ec2-admin-role"</span>
<span style="color: #268bd2;">}</span>
provider <span style="color: #2aa198;">"aws"</span> <span style="color: #268bd2;">{</span>
  access_key = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{data.vault_aws_access_credentials.creds.access_key}</span><span style="color: #2aa198;">"</span>
  secret_key = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{data.vault_aws_access_credentials.creds.secret_key}</span><span style="color: #2aa198;">"</span>
  region  = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.aws_region}</span><span style="color: #2aa198;">"</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org195d1ee" class="outline-3">
<h3 id="org195d1ee"><span class="section-number-3">6.4</span> Generating random DB credentials and storing them in vault</h3>
<div class="outline-text-3" id="text-6-4">
<p>
Configuring Vault
</p>

<div class="org-src-container">
<pre class="src src-bash">provider <span style="color: #2aa198;">"vault"</span> <span style="color: #268bd2;">{</span>
  address = <span style="color: #2aa198;">"http://127.0.0.1:8200"</span>
  token = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.vault_token}</span><span style="color: #2aa198;">"</span>
<span style="color: #268bd2;">}</span>

</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #96A7A9; font-style: italic;">#</span><span style="color: #96A7A9; font-style: italic;">----- RDS ------</span>

<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">Credential generation</span>

resource <span style="color: #2aa198;">"random_string"</span> <span style="color: #2aa198;">"username"</span> <span style="color: #268bd2;">{</span>
  length = <span style="color: #6c71c4; font-weight: bold;">16</span>
  special = false
  number = false
  upper = false
<span style="color: #268bd2;">}</span>

resource <span style="color: #2aa198;">"random_string"</span> <span style="color: #2aa198;">"password"</span> <span style="color: #268bd2;">{</span>
  length = <span style="color: #6c71c4; font-weight: bold;">16</span>
  special = false
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">Store the creds in vault</span>

resource <span style="color: #2aa198;">"vault_generic_secret"</span> <span style="color: #2aa198;">"credentials"</span> <span style="color: #268bd2;">{</span>
  path = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.service_name}</span><span style="color: #2aa198;">/credentials/database/</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.dbname}</span><span style="color: #2aa198;">"</span>
  data_json = &lt;&lt;EOT
<span style="color: #2aa198;"> {</span>
<span style="color: #2aa198;">   "username": "${random_string.username.result}",</span>
<span style="color: #2aa198;">   "password": "${random_string.password.result}"</span>
<span style="color: #2aa198;"> }</span>
<span style="color: #2aa198;">EOT</span>
<span style="color: #268bd2;">}</span>


resource <span style="color: #2aa198;">"aws_db_instance"</span> <span style="color: #2aa198;">"wp_db"</span> <span style="color: #268bd2;">{</span>
  allocated_storage = <span style="color: #6c71c4; font-weight: bold;">10</span>
  engine = <span style="color: #2aa198;">"mysql"</span>
  engine_version = <span style="color: #2aa198;">"5.7"</span>
  instance_class = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.db_instance_class}</span><span style="color: #2aa198;">"</span>
  name = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.dbname}</span><span style="color: #2aa198;">"</span>
  username = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{random_string.username.result}</span><span style="color: #2aa198;">"</span>
  password = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{random_string.password.result}</span><span style="color: #2aa198;">"</span>
  db_subnet_group_name = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_db_subnet_group.wp_rds_subnetgroup.name}</span><span style="color: #2aa198;">"</span>
  vpc_security_group_ids = <span style="color: #d33682;">[</span><span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{aws_security_group.wp_rds_sg.id}</span><span style="color: #2aa198;">"</span><span style="color: #d33682;">]</span>
  skip_final_snapshot = true
<span style="color: #268bd2;">}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash">variable <span style="color: #2aa198;">"service_name"</span> <span style="color: #268bd2;">{}</span>
variable <span style="color: #2aa198;">"blog_name"</span> <span style="color: #268bd2;">{}</span>
variable <span style="color: #2aa198;">"vault_token"</span> <span style="color: #268bd2;">{}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash">service_name = <span style="color: #2aa198;">"secret"</span>
blog_name = <span style="color: #2aa198;">"At Cloudbase"</span>
vault_token = <span style="color: #2aa198;">"s.Q08DkKLVIkDJy2vQpcUliLYE"</span>
</pre>
</div>

<p>
New user<sub>data</sub> script for the dev instance using the credentials and pre-configuring Wordpress
</p>

<div class="org-src-container">
<pre class="src src-bash">
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">Auto-install Wordpress With Creds and wp-config.php already sorted</span>

data <span style="color: #2aa198;">"template_file"</span> <span style="color: #2aa198;">"user_data"</span> <span style="color: #268bd2;">{</span>
  template = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{file("</span><span style="color: #268bd2;">user_data.tpl</span><span style="color: #268bd2;">")}</span><span style="color: #2aa198;">"</span>

  vars <span style="color: #d33682;">{</span>
   dbuser = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{random_string.username.result}</span><span style="color: #2aa198;">"</span>,
   dbpass = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{random_string.password.result}</span><span style="color: #2aa198;">"</span>,
   dbname = <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{var.dbname}</span><span style="color: #2aa198;">"</span>
  <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>

<p>
Auto-config user<sub>data</sub> script
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #96A7A9; font-style: italic;">#</span><span style="color: #96A7A9; font-style: italic;">!/usr/bin/</span><span style="color: #859900;">env</span><span style="color: #96A7A9; font-style: italic;"> bash</span>

<span style="color: #96A7A9; font-style: italic;">#</span><span style="color: #96A7A9; font-style: italic;">download wordpress</span>
<span style="color: #b58900; font-style: italic;">curl</span> -O https://wordpress.org/latest.tar.gz
<span style="color: #96A7A9; font-style: italic;">#</span><span style="color: #96A7A9; font-style: italic;">unzip wordpress</span>
tar -zxvf latest.tar.gz
<span style="color: #96A7A9; font-style: italic;">#</span><span style="color: #96A7A9; font-style: italic;">change dir to wordpress</span>
<span style="color: #b58900; font-style: italic;">cd</span> wordpress
<span style="color: #96A7A9; font-style: italic;">#</span><span style="color: #96A7A9; font-style: italic;">copy file to parent dir</span>
<span style="color: #b58900; font-style: italic;">cp</span> -rf . ..
<span style="color: #96A7A9; font-style: italic;">#</span><span style="color: #96A7A9; font-style: italic;">move back to parent dir</span>
<span style="color: #b58900; font-style: italic;">cd</span> ..
<span style="color: #96A7A9; font-style: italic;">#</span><span style="color: #96A7A9; font-style: italic;">remove files from wordpress folder</span>
<span style="color: #b58900; font-style: italic;">rm</span> -R wordpress
<span style="color: #96A7A9; font-style: italic;">#</span><span style="color: #96A7A9; font-style: italic;">create wp config</span>
<span style="color: #b58900; font-style: italic;">cp</span> wp-config-sample.php wp-config.php
<span style="color: #96A7A9; font-style: italic;">#</span><span style="color: #96A7A9; font-style: italic;">set database details with perl </span><span style="color: #96A7A9; font-style: italic;">find</span><span style="color: #96A7A9; font-style: italic;"> and replace</span>
perl -pi -e <span style="color: #2aa198;">"s/database_name_here/</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{dbname}</span><span style="color: #2aa198;">/g"</span> wp-config.php
perl -pi -e <span style="color: #2aa198;">"s/username_here/</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{dbuser}</span><span style="color: #2aa198;">/g"</span> wp-config.php
perl -pi -e <span style="color: #2aa198;">"s/password_here/</span><span style="color: #6c71c4;">$</span><span style="color: #268bd2;">{dbpass}</span><span style="color: #2aa198;">/g"</span> wp-config.php

<span style="color: #96A7A9; font-style: italic;">#</span><span style="color: #96A7A9; font-style: italic;">set WP salts</span>
perl -i -pe<span style="color: #2aa198;">'</span>
<span style="color: #2aa198;">  BEGIN {</span>
<span style="color: #2aa198;">    @chars = ("a" .. "z", "A" .. "Z", 0 .. 9);</span>
<span style="color: #2aa198;">    push @chars, split //, "!@#$%^&amp;*()-_ []{}&lt;&gt;~\`+=,.;:/?|";</span>
<span style="color: #2aa198;">    sub salt { join "", map $chars[ rand @chars ], 1 .. 64 }</span>
<span style="color: #2aa198;">  }</span>
<span style="color: #2aa198;">  s/put your unique phrase here/salt()/ge</span>
<span style="color: #2aa198;">'</span> wp-config.php

<span style="color: #96A7A9; font-style: italic;">#</span><span style="color: #96A7A9; font-style: italic;">create uploads folder and set permissions</span>
<span style="color: #b58900; font-style: italic;">mkdir</span> wp-content/uploads
<span style="color: #b58900; font-style: italic;">chmod</span> <span style="color: #6c71c4; font-weight: bold;">775</span> wp-content/uploads
<span style="color: #b58900; font-style: italic;">echo</span> <span style="color: #2aa198;">"Cleaning..."</span>
<span style="color: #96A7A9; font-style: italic;">#</span><span style="color: #96A7A9; font-style: italic;">remove zip file</span>
<span style="color: #b58900; font-style: italic;">rm</span> latest.tar.gz

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org34ae8d4" class="outline-2">
<h2 id="org34ae8d4"><span class="section-number-2">7</span> TODOS <code>[0/2]</code></h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-orgeca326a" class="outline-3">
<h3 id="orgeca326a"><span class="section-number-3">7.1</span> <span class="todo TODO">TODO</span> Add a bastion host to get into production via SSH</h3>
</div>
<div id="outline-container-org6776e5b" class="outline-3">
<h3 id="org6776e5b"><span class="section-number-3">7.2</span> <span class="todo TODO">TODO</span> Secure key access to dev host with Vault</h3>
<div class="outline-text-3" id="text-7-2">
<p>
<a href="https://learn.hashicorp.com/vault/secrets-management/sm-ssh-otp">https://learn.hashicorp.com/vault/secrets-management/sm-ssh-otp</a>
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Alex Springer</p>
<p class="date">Created: 2019-03-11 Mon 13:36</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
